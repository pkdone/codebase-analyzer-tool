<%- include('../common/section-header', { title: 'Database Stored Procedures & Triggers', jsonFile: jsonFilesConfig.jsonDataFiles.procsAndTriggers, jsonIconSvg: jsonIconSvg }) %>

<div class="stats-grid">
  <div class="card">
    <span class="card-title">Stored Procedures</span>
    <span class="card-value"><%= procsAndTriggers.procs.total %></span>
  </div>
  <div class="card">
    <span class="card-title">Triggers</span>
    <span class="card-value"><%= procsAndTriggers.trigs.total %></span>
  </div>
  <div class="card">
    <span class="card-title">Low Complexity</span>
    <span class="card-value"><%= procsAndTriggers.procs.low + procsAndTriggers.trigs.low %></span>
  </div>
  <div class="card">
    <span class="card-title">Medium Complexity</span>
    <span class="card-value"><%= procsAndTriggers.procs.medium + procsAndTriggers.trigs.medium %></span>
  </div>
  <div class="card">
    <span class="card-title">High Complexity</span>
    <span class="card-value"><%= procsAndTriggers.procs.high + procsAndTriggers.trigs.high %></span>
  </div>
</div>

<% const combinedProcsTrigsList = [ ...procsAndTriggers.procs.list, ...procsAndTriggers.trigs.list ]; %>

<% if (combinedProcsTrigsList && combinedProcsTrigsList.length > 0) { %>
  <div class="card-grid">
    <% combinedProcsTrigsList.forEach(item => { %>
      <div class="info-card">
        <h3>
          <%= item.functionName %>
          <% if (item.type === 'STORED PROCEDURE') { %>
            <span class="badge badge-proc">Procedure</span>
          <% } else { %>
            <span class="badge badge-trig">Trigger</span>
          <% } %>
        </h3>
        <p><strong>Path:</strong> <code><%= item.path %></code></p>
        <p><strong>Complexity:</strong> <%= item.complexity %> (<%= item.complexityReason %>)</p>
        <p><strong>Lines:</strong> <%= item.linesOfCode %></p>
        <p><strong>Purpose:</strong> <%= item.purpose %></p>
      </div>
    <% }); %>
  </div>
<% } else { %>
  <p>No stored procedures or triggers found.</p>
<% } %>

<%- include('../common/section-header', { title: 'Database Interactions', jsonFile: jsonFilesConfig.jsonDataFiles.dbInteractions, jsonIconSvg: jsonIconSvg }) %>

<% if (dbInteractions && dbInteractions.length > 0) { %>
  <table class="data-table">
    <thead>
      <tr>
        <th class="col-medium">Path</th>
        <th class="col-small">Mechanism</th>
        <th class="col-description">Description</th>
        <th class="col-wide">Code Example</th>
      </tr>
    </thead>
    <tbody>
      <% dbInteractions.forEach(item => { %>
        <tr>
          <td><code><%= item.path %></code></td>
          <td><%= item.mechanism %></td>
          <td><%= item.description %></td>
          <td>
            <pre><code class="language-sql"><%= item.codeExample %></code></pre>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
<% } else { %>
  <p>No database interactions found.</p>
<% } %>
